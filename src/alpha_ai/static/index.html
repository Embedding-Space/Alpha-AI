<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha AI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Markdown and syntax highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css">
    <style>
        /* Custom styles for markdown content */
        .markdown-content h1 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content h2 { font-size: 1.25rem; line-height: 1.75rem; font-weight: 700; margin-top: 0.75rem; margin-bottom: 0.5rem; }
        .markdown-content h3 { font-size: 1.125rem; line-height: 1.75rem; font-weight: 600; margin-top: 0.5rem; margin-bottom: 0.25rem; }
        .markdown-content p { margin-bottom: 1rem; }
        .markdown-content p:last-child { margin-bottom: 0; }
        .markdown-content ul { list-style-type: disc; list-style-position: inside; margin-bottom: 1rem; }
        .markdown-content ol { list-style-type: decimal; list-style-position: inside; margin-bottom: 1rem; }
        .markdown-content li { margin-bottom: 0.25rem; }
        .markdown-content li > p { display: inline; margin-bottom: 0; }
        .markdown-content li > p:first-child { display: inline; }
        .markdown-content code { background-color: rgb(55 65 81); padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .markdown-content pre { background-color: rgb(31 41 55); padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .markdown-content pre code { background-color: transparent; padding: 0; }
        .markdown-content blockquote { border-left-width: 4px; border-left-color: rgb(75 85 99); padding-left: 1rem; font-style: italic; color: rgb(156 163 175); }
        .markdown-content a { color: rgb(96 165 250); text-decoration: none; }
        .markdown-content a:hover { text-decoration: underline; }
        .markdown-content table { border-collapse: collapse; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .markdown-content th, .markdown-content td { border: 1px solid rgb(75 85 99); padding: 0.25rem 0.75rem; }
        .markdown-content th { background-color: rgb(55 65 81); }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 0.5rem; }
        ::-webkit-scrollbar-track { background: rgb(31 41 55); }
        ::-webkit-scrollbar-thumb { background: rgb(75 85 99); border-radius: 0.25rem; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(107 114 128); }

        /* Custom animation for typing indicator */
        @keyframes pulse {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }
        .typing-dot { animation: pulse 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Stop button styling */
        #send-button.stop {
            background-color: rgb(239 68 68) !important;
        }
        #send-button.stop:hover {
            background-color: rgb(220 38 38) !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col h-screen">
    <!-- Header -->
    <div class="px-4 py-3 bg-gray-800 border-b border-gray-700 flex items-center gap-4">
        
        <!-- Model Selector Button -->
        <button id="model-selector-btn" class="flex items-center gap-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
            <span id="current-model-name" class="text-sm">Select model...</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </button>
        
        <!-- Model Pricing Info -->
        <div id="model-pricing" class="text-sm text-gray-400 flex items-center gap-3">
            <span id="input-price" class="hidden">
                <span class="text-gray-500">Input:</span> <span class="text-gray-300">$<span class="price-value">-</span>/M</span>
            </span>
            <span id="output-price" class="hidden">
                <span class="text-gray-500">Output:</span> <span class="text-gray-300">$<span class="price-value">-</span>/M</span>
            </span>
        </div>
    </div>
    
    <!-- Messages Container -->
    <div id="messages" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
    
    <!-- Input Container -->
    <div class="p-4 bg-gray-800 border-t border-gray-700 flex gap-3 items-end">
        <textarea id="input" placeholder="Select a model first..." rows="1" disabled
            class="flex-1 bg-gray-700 border border-gray-600 rounded-3xl px-5 py-3 text-base resize-none outline-none focus:border-gray-500 placeholder-gray-400 min-h-[48px] max-h-32"></textarea>
        <button id="send-button" title="Send message" disabled
            class="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition-all hover:scale-105 disabled:bg-gray-600 disabled:cursor-not-allowed opacity-50 cursor-not-allowed">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
            </svg>
        </button>
    </div>

    <!-- Model Selector Modal -->
    <div id="model-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl max-w-3xl w-full h-[80vh] flex flex-col">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-semibold">Select Model</h2>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div class="relative">
                    <input type="text" id="model-search" placeholder="Search models..." 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 pl-10 outline-none focus:border-gray-500 placeholder-gray-400">
                    <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>

            <!-- Model List -->
            <div id="model-list" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Models will be dynamically inserted here -->
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700 flex justify-between items-center">
                <div class="text-sm text-gray-400">
                    <span id="model-count">0</span> models available
                </div>
                <button id="start-new-chat" 
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">
                    Start New Chat
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/v1';
        const messagesDiv = document.getElementById('messages');
        const input = document.getElementById('input');
        const sendButton = document.getElementById('send-button');
        const modelSelectorBtn = document.getElementById('model-selector-btn');
        const currentModelName = document.getElementById('current-model-name');
        const modelModal = document.getElementById('model-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modelSearch = document.getElementById('model-search');
        const modelList = document.getElementById('model-list');
        const modelCount = document.getElementById('model-count');
        const inputPriceEl = document.getElementById('input-price');
        const outputPriceEl = document.getElementById('output-price');
        const startNewChatBtn = document.getElementById('start-new-chat');
        
        let typingIndicator = null;
        let typingIndicatorTimeout = null;
        let useStreaming = true;  // Will be set based on server config
        let currentReader = null;
        let availableModels = [];
        let currentModel = null;
        let selectedModel = null;
        
        // Configure marked
        marked.setOptions({
            gfm: true,
            breaks: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {
                        console.error('Highlight error:', err);
                    }
                }
                return hljs.highlightAuto(code).value;
            }
        });
        
        // Render markdown
        function renderMarkdown(text) {
            const normalized = text
                .replace(/\n\s*\n\s*\n+/g, '\n\n')
                .replace(/\n\n+/g, '\n\n')
                .trim();
            
            const html = marked.parse(normalized);
            return html.replace(/<p>\s*<\/p>\s*$/g, '').trim();
        }
        
        // Modal handling
        modelSelectorBtn.addEventListener('click', async () => {
            modelModal.classList.remove('hidden');
            
            // Clear search and show empty state
            modelSearch.value = '';
            modelList.innerHTML = `
                <div class="flex items-center justify-center py-24 text-gray-500">
                    <div class="text-center">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <p class="text-lg">Start typing to search models</p>
                        <p class="text-sm mt-1">Try "gpt", "claude", or "llama"</p>
                    </div>
                </div>
            `;
            modelCount.textContent = '0';
            
            // Load models in background if not already loaded
            if (availableModels.length === 0) {
                loadModels().then(() => {
                    // Update count but don't render unless there's a search term
                    modelCount.textContent = availableModels.length;
                });
            }
            
            selectedModel = currentModel;
            modelSearch.focus();
        });
        
        closeModalBtn.addEventListener('click', () => {
            modelModal.classList.add('hidden');
        });
        
        modelModal.addEventListener('click', (e) => {
            if (e.target === modelModal) {
                modelModal.classList.add('hidden');
            }
        });
        
        // Model search
        modelSearch.addEventListener('input', (e) => {
            renderModelList(e.target.value.toLowerCase());
        });
        
        // Update input state based on model selection
        function updateInputState() {
            const hasModel = currentModel !== null;
            input.disabled = !hasModel;
            sendButton.disabled = !hasModel;
            
            if (!hasModel) {
                input.placeholder = 'Select a model first...';
                sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                input.placeholder = 'Message Alpha...';
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // Update pricing display
        function updatePricingDisplay(model) {
            if (!model) {
                inputPriceEl.classList.add('hidden');
                outputPriceEl.classList.add('hidden');
                return;
            }
            
            // Update input price
            if (model.input_cost !== null && model.input_cost !== undefined) {
                inputPriceEl.classList.remove('hidden');
                inputPriceEl.querySelector('.price-value').textContent = model.input_cost.toFixed(2);
            } else {
                inputPriceEl.classList.add('hidden');
            }
            
            // Update output price
            if (model.output_cost !== null && model.output_cost !== undefined) {
                outputPriceEl.classList.remove('hidden');
                outputPriceEl.querySelector('.price-value').textContent = model.output_cost.toFixed(2);
            } else {
                outputPriceEl.classList.add('hidden');
            }
        }
        
        // Load models
        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE}/models`);
                const data = await response.json();
                
                availableModels = data.models;
                
                // Set currentModel from server if we don't have one from conversation history
                if (!currentModel && data.current) {
                    currentModel = data.current;
                    selectedModel = currentModel;
                }
                
                // Update current model display only if not already set by loadHistory
                if (currentModel) {
                    const model = availableModels.find(m => m.id === currentModel);
                    if (model) {
                        // Only update if it's still showing "Select model..." 
                        // (i.e., wasn't already set by loadHistory)
                        if (currentModelName.textContent === 'Select model...') {
                            currentModelName.textContent = model.name;
                        }
                        updatePricingDisplay(model);
                    }
                } else {
                    currentModelName.textContent = 'Select model...';
                    updatePricingDisplay(null);
                }
                
                // Update input state based on model selection
                updateInputState();
                
                modelCount.textContent = availableModels.length;
            } catch (error) {
                console.error('Error loading models:', error);
                currentModelName.textContent = 'Error loading models';
            }
        }
        
        // Render model list
        function renderModelList(searchTerm = '') {
            // If no search term, show empty state
            if (!searchTerm) {
                modelList.innerHTML = `
                    <div class="flex items-center justify-center py-24 text-gray-500">
                        <div class="text-center">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <p class="text-lg">Start typing to search models</p>
                            <p class="text-sm mt-1">Try "gpt", "claude", or "llama"</p>
                        </div>
                    </div>
                `;
                modelCount.textContent = availableModels.length;
                return;
            }
            
            let filteredModels = [];
            
            availableModels.forEach(model => {
                const matchesSearch = 
                    model.name.toLowerCase().includes(searchTerm) ||
                    model.provider.toLowerCase().includes(searchTerm) ||
                    model.id.toLowerCase().includes(searchTerm);
                
                if (matchesSearch) {
                    filteredModels.push(model);
                }
            });
            
            // Update count
            modelCount.textContent = `${filteredModels.length} of ${availableModels.length}`;
            
            // Clear and render
            modelList.innerHTML = '';
            
            // Show no results message if needed
            if (filteredModels.length === 0) {
                modelList.innerHTML = `
                    <div class="flex items-center justify-center py-24 text-gray-500">
                        <div class="text-center">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-lg">No models found</p>
                            <p class="text-sm mt-1">Try a different search term</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group models by provider
            const modelsByProvider = {};
            filteredModels.forEach(model => {
                if (!modelsByProvider[model.provider]) {
                    modelsByProvider[model.provider] = [];
                }
                modelsByProvider[model.provider].push(model);
            });
            
            // Sort providers alphabetically
            const sortedProviders = Object.keys(modelsByProvider).sort();
            
            // Sort models within each provider alphabetically
            sortedProviders.forEach(provider => {
                modelsByProvider[provider].sort((a, b) => a.name.localeCompare(b.name));
            });
            
            // Track expanded providers
            if (!window.expandedProviders) {
                window.expandedProviders = new Set(sortedProviders); // All expanded by default
            }
            
            // Create container
            const modelsContainer = document.createElement('div');
            modelsContainer.className = 'space-y-3';
            
            // Render each provider group
            sortedProviders.forEach(provider => {
                const providerGroup = document.createElement('div');
                providerGroup.className = 'space-y-1';
                
                // Provider header
                const providerHeader = document.createElement('button');
                providerHeader.className = 'w-full text-left text-sm font-medium text-gray-300 hover:text-white transition-colors flex items-center gap-2';
                
                const isExpanded = window.expandedProviders.has(provider);
                
                const caret = document.createElement('i');
                caret.className = `fas fa-caret-${isExpanded ? 'down' : 'right'} text-xs`;
                
                const providerText = document.createElement('span');
                providerText.textContent = provider;
                
                providerHeader.appendChild(caret);
                providerHeader.appendChild(providerText);
                
                providerHeader.addEventListener('click', () => {
                    if (window.expandedProviders.has(provider)) {
                        window.expandedProviders.delete(provider);
                    } else {
                        window.expandedProviders.add(provider);
                    }
                    renderModelList(searchTerm);
                });
                
                providerGroup.appendChild(providerHeader);
                
                // Models container
                if (isExpanded) {
                    const modelsInProvider = document.createElement('div');
                    modelsInProvider.className = 'space-y-1';
                    
                    modelsByProvider[provider].forEach(model => {
                        const modelCard = document.createElement('button');
                        modelCard.className = `w-full p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors text-left flex items-center justify-between ${
                            model.id === selectedModel ? 'ring-2 ring-blue-500' : ''
                        }`;
                        
                        // Model name
                        const modelName = document.createElement('div');
                        modelName.className = 'text-sm text-white flex-1';
                        modelName.textContent = model.name;
                        
                        // Pricing
                        const pricingDiv = document.createElement('div');
                        pricingDiv.className = 'text-xs text-gray-400 text-right';
                        
                        if (model.input_cost !== null || model.output_cost !== null) {
                            const prices = [];
                            if (model.input_cost !== null) {
                                prices.push(`$${model.input_cost.toFixed(2)}/M input`);
                            }
                            if (model.output_cost !== null) {
                                prices.push(`$${model.output_cost.toFixed(2)}/M output`);
                            }
                            pricingDiv.textContent = prices.join(' â€¢ ');
                        }
                        
                        modelCard.appendChild(modelName);
                        modelCard.appendChild(pricingDiv);
                        
                        modelCard.addEventListener('click', (e) => {
                            e.stopPropagation();
                            selectedModel = model.id;
                            renderModelList(searchTerm);
                        });
                        
                        modelsInProvider.appendChild(modelCard);
                    });
                    
                    providerGroup.appendChild(modelsInProvider);
                }
                
                modelsContainer.appendChild(providerGroup);
            });
            
            modelList.appendChild(modelsContainer);
            
            // Update start button state and text
            startNewChatBtn.disabled = !selectedModel;
            if (selectedModel === currentModel) {
                startNewChatBtn.textContent = 'Clear Chat & Continue';
            } else {
                startNewChatBtn.textContent = 'Start New Chat';
            }
        }
        
        // Start new chat
        startNewChatBtn.addEventListener('click', async () => {
            if (!selectedModel) return;
            
            try {
                startNewChatBtn.disabled = true;
                const originalText = startNewChatBtn.textContent;
                startNewChatBtn.textContent = selectedModel === currentModel ? 'Clearing...' : 'Starting...';
                
                const response = await fetch(`${API_BASE}/conversation/new`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: selectedModel })
                });
                
                if (response.ok) {
                    messagesDiv.innerHTML = '';
                    currentModel = selectedModel;
                    const model = availableModels.find(m => m.id === currentModel);
                    if (model) {
                        currentModelName.textContent = model.name;
                        updatePricingDisplay(model);
                    }
                    updateInputState(); // Enable input and send button
                    modelModal.classList.add('hidden');
                    input.focus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to start new conversation'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                startNewChatBtn.disabled = false;
                startNewChatBtn.textContent = selectedModel === currentModel ? 'Clear Chat & Continue' : 'Start New Chat';
            }
        });
        
        // Auto-resize textarea
        input.addEventListener('input', () => {
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
        });
        
        // Handle enter/shift+enter
        input.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendButton.disabled && !sendButton.classList.contains('stop')) {
                    await sendMessage();
                }
            }
        });
        
        // Handle send/stop button
        sendButton.addEventListener('click', async () => {
            if (sendButton.classList.contains('stop')) {
                stopGeneration();
            } else {
                await sendMessage();
            }
        });
        
        // Add message to UI
        function addMessage(role, content, toolCalls = null) {
            // Clear typing indicator timeout if pending
            if (typingIndicatorTimeout) {
                clearTimeout(typingIndicatorTimeout);
                typingIndicatorTimeout = null;
            }
            
            if (typingIndicator) {
                typingIndicator.remove();
                typingIndicator = null;
            }
            
            // Add tool calls if present
            if (role === 'assistant' && toolCalls && toolCalls.length > 0) {
                const toolCallsDiv = document.createElement('div');
                toolCallsDiv.className = 'max-w-4xl mx-auto';
                
                toolCalls.forEach((toolCallPair) => {
                    const [call, result] = toolCallPair;
                    const toolDiv = createToolCallElement(call, result);
                    toolCallsDiv.appendChild(toolDiv);
                });
                
                messagesDiv.appendChild(toolCallsDiv);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `max-w-4xl mx-auto ${role === 'user' ? 'flex justify-end' : ''}`;
            
            const bubble = document.createElement('div');
            bubble.className = `inline-block max-w-[70%] px-4 py-3 rounded-2xl ${
                role === 'user' ? 'bg-blue-600 text-white' : 
                role === 'assistant' ? 'bg-gray-700' : 
                'mx-auto text-center text-gray-400 text-sm'
            }`;
            
            if (role === 'assistant') {
                bubble.innerHTML = `<div class="markdown-content">${renderMarkdown(content)}</div>`;
            } else {
                bubble.textContent = content;
            }
            
            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Create tool call element
        function createToolCallElement(call, result) {
            const toolDiv = document.createElement('details');
            toolDiv.className = 'mb-2 bg-gray-800 border border-gray-700 rounded-lg overflow-hidden';
            
            const summary = document.createElement('summary');
            summary.className = 'px-4 py-3 cursor-pointer hover:bg-gray-700 transition-colors flex items-center gap-2 text-sm text-gray-400';
            summary.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                </svg>
                ${call.tool_name}
            `;
            
            const content = document.createElement('div');
            content.className = 'px-4 py-3 border-t border-gray-700 space-y-3';
            content.innerHTML = `
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-1">Request</h4>
                    <pre class="bg-gray-900 p-3 rounded text-xs overflow-x-auto"><code>${JSON.stringify(call.args, null, 2)}</code></pre>
                </div>
                ${result ? `
                <div>
                    <h4 class="text-xs uppercase text-gray-500 mb-1">Response</h4>
                    <pre class="bg-gray-900 p-3 rounded text-xs overflow-x-auto"><code>${JSON.stringify({ content: result.content }, null, 2)}</code></pre>
                </div>
                ` : '<div class="text-sm text-gray-500">Waiting for response...</div>'}
            `;
            
            toolDiv.appendChild(summary);
            toolDiv.appendChild(content);
            return toolDiv;
        }
        
        // Show typing indicator with delay to prevent flash
        function showTypingIndicator() {
            if (typingIndicator) return;
            
            // Clear any existing timeout
            if (typingIndicatorTimeout) {
                clearTimeout(typingIndicatorTimeout);
            }
            
            // Only show typing indicator after a short delay
            // This prevents the flash for very fast responses
            typingIndicatorTimeout = setTimeout(() => {
                if (!typingIndicator) {
                    typingIndicator = document.createElement('div');
                    typingIndicator.className = 'max-w-4xl mx-auto';
                    typingIndicator.innerHTML = `
                        <div class="inline-block bg-gray-700 px-4 py-3 rounded-2xl">
                            <div class="flex gap-1">
                                <span class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></span>
                                <span class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></span>
                                <span class="w-2 h-2 bg-gray-500 rounded-full typing-dot"></span>
                            </div>
                        </div>
                    `;
                    messagesDiv.appendChild(typingIndicator);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }, 200); // 200ms delay before showing indicator
        }
        
        // Stop generation
        function stopGeneration() {
            if (currentReader) {
                currentReader.cancel();
                currentReader = null;
            }
            
            sendButton.classList.remove('stop');
            sendButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                </svg>
            `;
            sendButton.title = 'Send message';
            sendButton.disabled = false;
            
            // Clear typing indicator and timeout
            if (typingIndicatorTimeout) {
                clearTimeout(typingIndicatorTimeout);
                typingIndicatorTimeout = null;
            }
            
            if (typingIndicator) {
                typingIndicator.remove();
                typingIndicator = null;
            }
            
            addMessage('system', 'Generation stopped by user');
        }
        
        // Send message
        async function sendMessage() {
            const message = input.value.trim();
            if (!message || !currentModel) return;
            
            input.disabled = true;
            sendButton.disabled = true;
            
            input.value = '';
            input.style.height = 'auto';
            
            addMessage('user', message);
            showTypingIndicator();
            
            if (useStreaming) {
                await sendMessageStreaming(message);
            } else {
                await sendMessageNonStreaming(message);
            }
            
            input.disabled = false;
            input.focus();
        }
        
        // Non-streaming send
        async function sendMessageNonStreaming(message) {
            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage('assistant', data.response, data.tool_calls);
                } else {
                    addMessage('system', `Error: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                addMessage('system', `Error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
            }
        }
        
        // Streaming send
        async function sendMessageStreaming(message) {
            try {
                sendButton.classList.add('stop');
                sendButton.innerHTML = `
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                    </svg>
                `;
                sendButton.title = 'Stop generation';
                sendButton.disabled = false;
                
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    addMessage('system', `Error: ${error.detail || 'Unknown error'}`);
                    return;
                }
                
                // Clear typing indicator and timeout
                if (typingIndicatorTimeout) {
                    clearTimeout(typingIndicatorTimeout);
                    typingIndicatorTimeout = null;
                }
                
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
                
                let currentMessageDiv = null;
                let currentMessageText = '';
                let pendingToolCalls = new Map();
                let currentToolCallsContainer = null;
                
                const reader = response.body.getReader();
                currentReader = reader;
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'text_delta') {
                                    if (!currentMessageDiv || !currentMessageDiv.parentNode) {
                                        const wrapper = document.createElement('div');
                                        wrapper.className = 'max-w-4xl mx-auto';
                                        
                                        currentMessageDiv = document.createElement('div');
                                        currentMessageDiv.className = 'inline-block max-w-[70%] px-4 py-3 rounded-2xl bg-gray-700';
                                        currentMessageDiv.innerHTML = '<div class="markdown-content"></div>';
                                        
                                        wrapper.appendChild(currentMessageDiv);
                                        messagesDiv.appendChild(wrapper);
                                        currentMessageText = '';
                                    }
                                    currentMessageText += data.content;
                                    currentMessageDiv.querySelector('.markdown-content').innerHTML = renderMarkdown(currentMessageText);
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                } else if (data.type === 'tool_call') {
                                    if (!currentToolCallsContainer) {
                                        currentToolCallsContainer = document.createElement('div');
                                        currentToolCallsContainer.className = 'max-w-4xl mx-auto';
                                    }
                                    
                                    const toolCallDiv = createToolCallElement(
                                        { tool_name: data.tool_name, args: data.args, tool_call_id: data.tool_call_id },
                                        null
                                    );
                                    currentToolCallsContainer.appendChild(toolCallDiv);
                                    pendingToolCalls.set(data.tool_call_id, toolCallDiv);
                                } else if (data.type === 'tool_return') {
                                    const toolCallDiv = pendingToolCalls.get(data.tool_call_id);
                                    if (toolCallDiv) {
                                        const contentDiv = toolCallDiv.querySelector('div:last-child');
                                        contentDiv.innerHTML = `
                                            <div>
                                                <h4 class="text-xs uppercase text-gray-500 mb-1">Request</h4>
                                                <pre class="bg-gray-900 p-3 rounded text-xs overflow-x-auto"><code>${JSON.stringify({ tool_name: data.tool_name, args: {} }, null, 2)}</code></pre>
                                            </div>
                                            <div>
                                                <h4 class="text-xs uppercase text-gray-500 mb-1">Response</h4>
                                                <pre class="bg-gray-900 p-3 rounded text-xs overflow-x-auto"><code>${JSON.stringify({ content: data.content }, null, 2)}</code></pre>
                                            </div>
                                        `;
                                    }
                                    
                                    if (currentToolCallsContainer && !currentToolCallsContainer.parentNode) {
                                        messagesDiv.appendChild(currentToolCallsContainer);
                                    }
                                    
                                    currentToolCallsContainer = null;
                                    currentMessageDiv = null;
                                    currentMessageText = '';
                                } else if (data.type === 'done') {
                                    if (currentToolCallsContainer && !currentToolCallsContainer.parentNode) {
                                        messagesDiv.appendChild(currentToolCallsContainer);
                                    }
                                    
                                    if (currentMessageDiv && !currentMessageText.trim()) {
                                        currentMessageDiv.parentNode.remove();
                                    }
                                    
                                    currentReader = null;
                                    sendButton.classList.remove('stop');
                                    sendButton.innerHTML = `
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                                        </svg>
                                    `;
                                    sendButton.title = 'Send message';
                                    sendButton.disabled = false;
                                } else if (data.type === 'error') {
                                    addMessage('system', `Error: ${data.error}`);
                                }
                            } catch (e) {
                                console.error('Failed to parse SSE data:', e);
                            }
                        }
                    }
                }
                
                if (currentMessageDiv && !currentMessageText.trim()) {
                    currentMessageDiv.parentNode.remove();
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    addMessage('system', `Error: ${error.message}`);
                }
            } finally {
                currentReader = null;
                sendButton.classList.remove('stop');
                sendButton.innerHTML = `
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                    </svg>
                `;
                sendButton.title = 'Send message';
                sendButton.disabled = false;
            }
        }
        
        // Load history
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/conversation`);
                const data = await response.json();
                
                // If there's a model in the conversation and we don't have one set, use it
                // Note: data.model might be empty string if server doesn't track it properly
                if (data.model && data.model !== '' && !currentModel) {
                    currentModel = data.model;
                    selectedModel = currentModel;
                    
                    // Update display immediately with what we have
                    // Extract the model name from the ID (e.g., "anthropic:claude-3-opus" -> "claude-3-opus")
                    const modelParts = currentModel.split(':');
                    const displayName = modelParts.length > 1 ? modelParts[1] : currentModel;
                    currentModelName.textContent = displayName;
                    
                    // Enable the input since we have a model
                    updateInputState();
                }
                
                data.messages.forEach(msg => {
                    addMessage(msg.role, msg.content, msg.tool_calls);
                });
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }
        
        // Check server configuration
        async function checkConfig() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                // Set streaming based on server config
                useStreaming = data.streaming !== false;
            } catch (error) {
                console.error('Error checking config:', error);
                // Default to streaming on error
                useStreaming = true;
            }
        }
        
        // Get just the current model info
        async function loadCurrentModel() {
            try {
                const response = await fetch(`${API_BASE}/model`);
                const data = await response.json();
                currentModel = data.model;
                // Show the model ID as the name initially
                currentModelName.textContent = currentModel.split(':')[1] || currentModel;
            } catch (error) {
                console.error('Error loading current model:', error);
                currentModelName.textContent = 'Unknown';
            }
        }
        
        // Initialize
        async function initialize() {
            await checkConfig();
            
            // Load history first to see if there's a model from the conversation
            await loadHistory();
            
            // Then load models (which will use the model from history if set)
            await loadModels();
            
            input.focus();
        }
        
        initialize();
    </script>
</body>
</html>